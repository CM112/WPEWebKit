From 26ba5099f19ba2e00f84aff797be7740fead4aee Mon Sep 17 00:00:00 2001
From: Philippe Normand <philn@igalia.com>
Date: Wed, 29 Sep 2021 10:22:00 +0100
Subject: [PATCH] cmake: Look for resources in cmake's install lib dir

---
 CMakeLists.txt  |  4 ++++
 src/config.h.in |  6 ++++++
 src/util.cc     | 11 +++--------
 3 files changed, 13 insertions(+), 8 deletions(-)
 create mode 100644 src/config.h.in

diff --git a/CMakeLists.txt b/CMakeLists.txt
index e28d95aa..d38b3df2 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -49,6 +49,10 @@ configure_file(
   ${CMAKE_SOURCE_DIR}/src/git_revision.h.in
   ${CMAKE_BINARY_DIR}/git_revision.h
 )
+configure_file(
+  ${CMAKE_SOURCE_DIR}/src/config.h.in
+  ${CMAKE_BINARY_DIR}/config.h
+)
 
 set(FLAGS_COMMON "-D__USE_LARGEFILE64 -pthread")
 set(supports32bit true)
diff --git a/src/config.h.in b/src/config.h.in
new file mode 100644
index 00000000..059aeb43
--- /dev/null
+++ b/src/config.h.in
@@ -0,0 +1,6 @@
+#ifndef RR_CONFIG_H_
+#define RR_CONFIG_H_
+
+#define RESOURCES_LIB_DIR "@CMAKE_INSTALL_PREFIX@/@CMAKE_INSTALL_LIBDIR@/"
+
+#endif
diff --git a/src/util.cc b/src/util.cc
index c57ae7b6..b2ac7bac 100644
--- a/src/util.cc
+++ b/src/util.cc
@@ -45,6 +45,7 @@
 #include "kernel_metadata.h"
 #include "log.h"
 #include "seccomp-bpf.h"
+#include "config.h"
 
 void good_random(uint8_t* out, size_t out_len);
 
@@ -1261,8 +1262,7 @@ static string read_exe_dir() {
 string resource_path() {
   string resource_path = Flags::get().resource_path;
   if (resource_path.empty()) {
-    static string exe_path = read_exe_dir() + "../";
-    return exe_path;
+    return RESOURCES_LIB_DIR;
   }
   return resource_path;
 }
@@ -1294,16 +1294,11 @@ bool running_under_rr(bool cache) {
 
 string find_helper_library(const char *basepath)
 {
-  string lib_path = resource_path() + "lib64/rr/";
+  string lib_path = resource_path() + "rr/";
   string file_name = lib_path + basepath;
   if (access(file_name.c_str(), F_OK) == 0) {
     return lib_path;
   }
-  lib_path = resource_path() + "lib/rr/";
-  file_name = lib_path + basepath;
-  if (access(file_name.c_str(), F_OK) == 0) {
-    return lib_path;
-  }
   // File does not exist. Assume install put it in LD_LIBRARY_PATH.
   lib_path = "";
   return lib_path;
-- 
2.31.1

